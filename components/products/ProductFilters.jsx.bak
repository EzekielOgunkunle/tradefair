'use client'

import { useState, useEffect } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Slider } from '@/components/ui/slider'
import { Badge } from '@/components/ui/badge'
import { Checkbox } from '@/components/ui/checkbox'
import { X, Filter, Star, Save, Check } from 'lucide-react'
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion'
import toast from 'react-hot-toast'

export default function ProductFilters({ categories, searchParams }) {
  const router = useRouter()
  const params = useSearchParams()
  
  const [priceRange, setPriceRange] = useState([
    Number(params.get('minPrice')) || 0,
    Number(params.get('maxPrice')) || 100000,
  ])
  const [minRating, setMinRating] = useState(Number(params.get('minRating')) || 0)
  const [inStockOnly, setInStockOnly] = useState(params.get('inStock') === 'true')
  const [preferencesSaved, setPreferencesSaved] = useState(false)

  const applyFilters = (newParams) => {
    const current = new URLSearchParams(params.toString())
    
    Object.entries(newParams).forEach(([key, value]) => {
      if (value) {
        current.set(key, value)
      } else {
        current.delete(key)
      }
    })
    
    // Reset to page 1 when filters change
    current.set('page', '1')
    
    router.push(`/products?${current.toString()}`)
  }

  const clearFilters = () => {
    setPriceRange([0, 100000])
    setMinRating(0)
    setInStockOnly(false)
    router.push('/products')
  }

  const savePreferences = () => {
    const prefs = {
      category: params.get('category'),
      minRating,
      sortBy: params.get('sortBy'),
      minPrice: params.get('minPrice'),
      maxPrice: params.get('maxPrice'),
    }
    localStorage.setItem('filterPreferences', JSON.stringify(prefs))
    setPreferencesSaved(true)
    toast.success('Filter preferences saved!')
    setTimeout(() => setPreferencesSaved(false), 2000)
  }

  const handleCategoryClick = (category) => {
    applyFilters({ category })
  }

  const handleSortChange = (sortBy) => {
    applyFilters({ sortBy })
  }

  const handlePriceApply = () => {
    applyFilters({
      minPrice: priceRange[0] > 0 ? priceRange[0] : '',
      maxPrice: priceRange[1] < 100000 ? priceRange[1] : '',
    })
  }

  const activeFiltersCount = [
    params.get('category'),
    params.get('minPrice'),
    params.get('maxPrice'),
    params.get('search'),
    params.get('minRating'),
    params.get('inStock'),
  ].filter(Boolean).length

  return (
    <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 sticky top-4">
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <Filter className="w-5 h-5 text-emerald-600 dark:text-emerald-400" />
          <h2 className="text-lg font-semibold text-gray-900 dark:text-white">Filters</h2>
          {activeFiltersCount > 0 && (
            <Badge variant="secondary" className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400">
              {activeFiltersCount}
            </Badge>
          )}
        </div>
        {activeFiltersCount > 0 && (
          <Button
            variant="ghost"
            size="sm"
            onClick={clearFilters}
            className="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"
          >
            <X className="w-4 h-4 mr-1" />
            Clear
          </Button>
        )}
      </div>

      {/* Save Preferences */}
      {activeFiltersCount > 0 && (
        <Button
          variant="outline"
          size="sm"
          onClick={savePreferences}
          className="w-full mb-4 border-emerald-200 text-emerald-700 hover:bg-emerald-50"
        >
          {preferencesSaved ? (
            <>
              <Check className="w-4 h-4 mr-2" />
              Saved!
            </>
          ) : (
            <>
              <Save className="w-4 h-4 mr-2" />
              Save Preferences
            </>
          )}
        </Button>
      )}

      <Accordion type="multiple" defaultValue={['sort', 'categories', 'price', 'rating', 'availability']} className="space-y-4">
        {/* Sort By */}
        <AccordionItem value="sort" className="border-none">
          <AccordionTrigger className="hover:no-underline py-2">
            <span className="font-medium text-gray-900 dark:text-white">Sort By</span>
          </AccordionTrigger>
          <AccordionContent className="pt-4">
            <Select onValueChange={handleSortChange} defaultValue={params.get('sortBy') || 'newest'}>
              <SelectTrigger className="w-full">
                <SelectValue placeholder="Select sorting" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="newest">Newest First</SelectItem>
                <SelectItem value="price-asc">Price: Low to High</SelectItem>
                <SelectItem value="price-desc">Price: High to Low</SelectItem>
                <SelectItem value="rating">Highest Rated</SelectItem>
                <SelectItem value="popular">Most Popular</SelectItem>
              </SelectContent>
            </Select>
          </AccordionContent>
        </AccordionItem>

        {/* Categories */}
        <AccordionItem value="categories" className="border-none">
          <AccordionTrigger className="hover:no-underline py-2">
            <span className="font-medium text-gray-900 dark:text-white">Categories</span>
          </AccordionTrigger>
          <AccordionContent className="pt-4">
            <div className="space-y-2 max-h-64 overflow-y-auto">
              {categories.map((category) => (
                <button
                  key={category}
                  onClick={() => handleCategoryClick(category)}
                  className={`w-full text-left px-3 py-2 rounded-lg transition-colors ${
                    params.get('category') === category
                      ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 font-medium'
                      : 'hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300'
                  }`}
                >
                  {category}
                </button>
              ))}
            </div>
          </AccordionContent>
        </AccordionItem>

        {/* Price Range */}
        <AccordionItem value="price" className="border-none">
          <AccordionTrigger className="hover:no-underline py-2">
            <span className="font-medium text-gray-900 dark:text-white">Price Range (₦)</span>
          </AccordionTrigger>
          <AccordionContent className="pt-4 space-y-4">
            <Slider
              value={priceRange}
              onValueChange={setPriceRange}
              max={100000}
              step={1000}
              className="w-full"
            />
            <div className="flex items-center gap-2">
              <Input
                type="number"
                value={priceRange[0]}
                onChange={(e) => setPriceRange([Number(e.target.value), priceRange[1]])}
                placeholder="Min"
                className="flex-1"
              />
              <span className="text-gray-500 dark:text-gray-400">-</span>
              <Input
                type="number"
                value={priceRange[1]}
                onChange={(e) => setPriceRange([priceRange[0], Number(e.target.value)])}
                placeholder="Max"
                className="flex-1"
              />
            </div>
            <Button
              onClick={handlePriceApply}
              className="w-full bg-emerald-600 hover:bg-emerald-700 text-white"
            >
              Apply Price Filter
            </Button>
          </AccordionContent>
        </AccordionItem>

        {/* Rating Filter */}
        <AccordionItem value="rating" className="border-none">
          <AccordionTrigger className="hover:no-underline py-2">
            <span className="font-medium text-gray-900 dark:text-white">Minimum Rating</span>
          </AccordionTrigger>
          <AccordionContent className="pt-4">
            <div className="space-y-2">
              {[4, 3, 2, 1].map((rating) => (
                <button
                  key={rating}
                  onClick={() => {
                    setMinRating(rating)
                    applyFilters({ minRating: rating })
                  }}
                  className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${
                    minRating === rating
                      ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 font-medium'
                      : 'hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300'
                  }`}
                >
                  <div className="flex items-center">
                    {[...Array(rating)].map((_, i) => (
                      <Star key={i} className="h-4 w-4 fill-yellow-400 text-yellow-400" />
                    ))}
                  </div>
                  <span className="text-sm">& Up</span>
                </button>
              ))}
              {minRating > 0 && (
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => {
                    setMinRating(0)
                    applyFilters({ minRating: '' })
                  }}
                  className="w-full text-xs"
                >
                  Clear Rating Filter
                </Button>
              )}
            </div>
          </AccordionContent>
        </AccordionItem>

        {/* Availability Filter */}
        <AccordionItem value="availability" className="border-none">
          <AccordionTrigger className="hover:no-underline py-2">
            <span className="font-medium text-gray-900 dark:text-white">Availability</span>
          </AccordionTrigger>
          <AccordionContent className="pt-4">
            <div className="flex items-center space-x-2">
              <Checkbox
                id="inStock"
                checked={inStockOnly}
                onCheckedChange={(checked) => {
                  setInStockOnly(checked)
                  applyFilters({ inStock: checked ? 'true' : '' })
                }}
              />
              <label
                htmlFor="inStock"
                className="text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer"
              >
                In Stock Only
              </label>
            </div>
          </AccordionContent>
        </AccordionItem>
      </Accordion>

      {/* Active Filters */}
      {activeFiltersCount > 0 && (
        <div className="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
          <h3 className="text-sm font-medium text-gray-900 dark:text-white mb-3">Active Filters</h3>
          <div className="flex flex-wrap gap-2">
            {params.get('category') && (
              <Badge
                variant="secondary"
                className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 cursor-pointer"
                onClick={() => applyFilters({ category: '' })}
              >
                {params.get('category')}
                <X className="w-3 h-3 ml-1" />
              </Badge>
            )}
            {params.get('search') && (
              <Badge
                variant="secondary"
                className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 cursor-pointer"
                onClick={() => applyFilters({ search: '' })}
              >
                Search: {params.get('search')}
                <X className="w-3 h-3 ml-1" />
              </Badge>
            )}
            {(params.get('minPrice') || params.get('maxPrice')) && (
              <Badge
                variant="secondary"
                className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 cursor-pointer"
                onClick={() => applyFilters({ minPrice: '', maxPrice: '' })}
              >
                ₦{params.get('minPrice') || 0} - ₦{params.get('maxPrice') || '100k+'}
                <X className="w-3 h-3 ml-1" />
              </Badge>
            )}
            {params.get('minRating') && (
              <Badge
                variant="secondary"
                className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 cursor-pointer"
                onClick={() => {
                  setMinRating(0)
                  applyFilters({ minRating: '' })
                }}
              >
                <Star className="h-3 w-3 mr-1 fill-yellow-400 text-yellow-400" />
                {params.get('minRating')}+ Stars
                <X className="w-3 h-3 ml-1" />
              </Badge>
            )}
            {params.get('inStock') === 'true' && (
              <Badge
                variant="secondary"
                className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 cursor-pointer"
                onClick={() => {
                  setInStockOnly(false)
                  applyFilters({ inStock: '' })
                }}
              >
                In Stock Only
                <X className="w-3 h-3 ml-1" />
              </Badge>
            )}
          </div>
        </div>
      )}
    </div>
  )
}
